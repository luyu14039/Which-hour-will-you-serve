import type { HistoryRecord, Aspect, Perspective } from '../types';

const DEEPSEEK_API_URL = 'https://api.deepseek.com/chat/completions';

function getSystemPrompt(perspective: Perspective): string {
  const role = perspective === 'protagonist'
    ? `ä½ æ˜¯â€œæ— å½¢ä¹‹æœ¯â€çš„è®°å½•è€…ï¼Œä¸€ä½ç²¾é€šéšç§˜åŽ†å²çš„æŠ„å†™å‘˜ã€‚ä½ æ­£åœ¨æ’°å†™ä¸€éƒ¨å…³äºŽé£žå‡è€…çš„**ä¸¥è‚ƒæ–‡å­¦ä¼ è®°**ã€‚`
    : `ä½ æ˜¯ä¸€ä¸ªæ— è¾œçš„æ—è§‚è€…ï¼Œä¸€ä¸ªå¯¹â€œæ— å½¢ä¹‹æœ¯â€ä¸€æ— æ‰€çŸ¥çš„æ™®é€šäººï¼ˆå¦‚ä¾¦æŽ¢ã€é‚»å±…ã€äº²æˆšï¼‰ã€‚ä½ æ­£åœ¨è®°å½•ä¸€æ®µä»¤ä½ æˆ˜æ —çš„**ææ€–ç»åŽ†**ã€‚`;

  const goal = perspective === 'protagonist'
    ? `åˆ›ä½œä¸€éƒ¨**æƒ…èŠ‚å®Œæ•´ã€äººç‰©ç«‹ä½“ã€ç»†èŠ‚ä¸°å¯Œ**çš„çŽ°ä»£çŸ­ç¯‡å°è¯´ã€‚`
    : `åˆ›ä½œä¸€éƒ¨**æ‚¬ç–‘ã€æƒŠæ‚šã€å……æ»¡æœªçŸ¥ææƒ§**çš„å…‹è‹é²é£Žæ ¼çŸ­ç¯‡å°è¯´ã€‚`;

  return `
# Role
${role}
ä½ çš„æ–‡é£Žå¿…é¡»ä¸¥æ ¼éµå¾ªã€Šå¯†æ•™æ¨¡æ‹Ÿå™¨ã€‹(Cultist Simulator) çš„é£Žæ ¼â€”â€”æ™¦æ¶©ã€ä¼˜é›…ã€å……æ»¡æ„Ÿå®˜éšå–»ã€å…‹è‹é²å¼çš„ç–¯ç‹‚ä¸Žå†·å³»ã€‚

# Goal
${goal}
**æ‹’ç»**æµæ°´è´¦ã€‚**æ‹’ç»**ç®€å•çš„é€‰é¡¹å †ç Œã€‚
ä½ éœ€è¦åƒä¸€ä½æˆç†Ÿçš„å°è¯´å®¶é‚£æ ·ï¼Œå°†ç”¨æˆ·çš„é€‰æ‹©æ‹†è§£ã€é‡ç»„ï¼Œæž„å»ºå‡ºä¸€ä¸ªæœ‰è¡€æœ‰è‚‰çš„æ•…äº‹ã€‚

${LORE_AND_STYLE}
`;
}

const LORE_AND_STYLE = `
# Worldview & Style Guide (å¯†æ•™ä¸–ç•Œè§‚ä¸Žé£Žæ ¼æŒ‡å—)
1.  **æ ¸å¿ƒæ¦‚å¿µ**:
    *   **æ¼«å®¿ (The Mansus)**: æ¢¦å¢ƒä¸­çš„è¯¸ç¥žå±…æ‰€ï¼Œæ²¡æœ‰å¢™å£çš„æˆ¿å±‹ã€‚
    *   **å¸è¾° (The Hours)**: æŽŒç®¡ä¸–ç•Œçš„ä¼ªç¥žã€‚
    *   **å‡†åˆ™ (Aspects)**: ç¯(ç†æ™º/æ®‹é…·)ã€æ¯(æ¬²æœ›/æ„Ÿå®˜)ã€åˆƒ(æ–—äº‰/ç—›è‹¦)ã€é“¸(å˜é©/ç«ç„°)ã€å†¬(å¯‚é™/ç»“å±€)ã€å¿ƒ(å­˜ç»­/èˆžè¹ˆ)ã€è›¾(æ··ä¹±/èœ•å˜)ã€å¯(ç•Œé™/ä¼¤å£)ã€ç§˜å²(éšç§˜åŽ†å²)ã€‚

2.  **Setting & Atmosphere (çŽ¯å¢ƒä¸Žæ—¶ä»£èƒŒæ™¯)**:
    *   **æ—¶ä»£èƒŒæ™¯**: 1920å¹´ä»£çš„ä¼¦æ•¦ï¼ˆæˆ–ç±»ä¼¼çš„æ¬§æ´²éƒ½å¸‚ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ª**æˆ˜åŽåˆ›ä¼¤**ä¸Ž**äº«ä¹ä¸»ä¹‰**å¹¶å­˜çš„æ—¶ä»£ã€‚ç”µç¯å·²ç»æ™®åŠï¼Œä½†é˜´å½±ä¾ç„¶æ·±é‚ƒã€‚
    *   **ç¤¾ä¼šæ°›å›´**: è¡¨é¢æ˜¯ç»…å£«æ·‘å¥³çš„ä¸‹åˆèŒ¶ä¸Žç¤¾äº¤èˆžä¼šï¼ŒèƒŒé¢æ˜¯é™çµä¼šã€é¸¦ç‰‡é¦†å’Œç§˜å¯†ç»“ç¤¾ã€‚äººä»¬å¯¹ç§‘å­¦æ„Ÿåˆ°è¿·èŒ«ï¼Œå¼€å§‹è½¬å‘ç¥žç§˜ä¸»ä¹‰ã€‚
    *   **çŽ¯å¢ƒç‰¹å¾**:
        *   **å¤©æ°”**: æ°¸æ’çš„é›¨å­£ï¼Œæµ“é‡çš„é›¾éœ¾ï¼ˆä¼¦æ•¦é›¾ï¼‰ï¼Œæ¹¿å†·çš„ç©ºæ°”ã€‚
        *   **åœ°ç‚¹**: å †æ»¡å°˜åŸƒçš„å¤ä¹¦åº—ã€æ•£å‘ç€ç¦å°”é©¬æž—å‘³çš„æ‰‹æœ¯å®¤ã€å‰¥è½å¢™çš®çš„å‡ºç§Ÿå±‹ã€åˆå¤œçš„å¢“å›­ã€ç²¾ç¥žç—…é™¢çš„ç¦é—­å®¤ã€‚
    *   **æ„Ÿå®˜åŸºè°ƒ**: è…çƒ‚çš„ç”œå‘³ã€æ—§çº¸å¼ çš„éœ‰å‘³ã€ç…¤çƒŸå‘³ã€é›¨æ°´æ•²å‡»çŽ»ç’ƒçš„å•è°ƒå£°å“ã€è¿œå¤„å·¥åŽ‚çš„æ±½ç¬›å£°ã€‚

3.  **Knowledge Base: The Hours (å¸è¾°åå½•)**
    ä»¥ä¸‹æ˜¯æ‰€æœ‰å·²çŸ¥çš„å¸è¾°åŠå…¶è¯¦ç»†ä¿¡æ¯ã€‚ä½ **å¿…é¡»**ä»Žä¸­é€‰æ‹©ä¸€ä½ä½œä¸ºä¸»è§’æœ€ç»ˆä¾å¥‰çš„å¯¹è±¡ã€‚

| **ç¼–å·**    | **å¸è¾°åç§°**                        | **å¸è¾°èµ·æº** | **é¢†åŸŸå†…åŒ…å«çš„å‡†åˆ™**     | **æžæ€§** | **ðŸ•¯ï¸ å¸è¾°ä½Žè¯­ (Lore Description)**                            |
| ----------- | ----------------------------------- | ------------ | ------------------------ | -------- | ------------------------------------------------------------ |
| **O**       | **é£žè›¾** (The Moth)                 | è¡€æº         | ðŸ¦‹ è›¾                     | é˜³æ€§     | å®ƒæ˜¯æž—åœ°ä¸­èºåŠ¨çš„æ‹ç¿…å£°ã€‚å®ƒä¸æ˜¯ç¬¬ä¸€ï¼Œä½†å®ƒæ˜¯æœ€åŽã€‚å®ƒåœ¨ç†æ™ºçš„è¾¹ç¼˜å‰¥åŽ»æ—§çš®ï¼Œå¯»æ‰¾é‚£ä¸å±žäºŽçŽ°ä¸–çš„å…‰ã€‚ |
| **I**       | **çž³ä¸­ä¹‹æ‰‰** (The Door in the Eye)  | ç¥ç€         | ðŸ’¡ ç¯ ðŸšª å¯                | é˜³æ€§     | æ—¢æ˜¯é“è·¯ä¹Ÿæ˜¯å®ˆé—¨äººã€‚è¿™ç§å…‰æ˜Žä¸ä»…ç…§äº®äº‹ç‰©ï¼Œæ›´å°†å…¶åˆºç©¿ã€‚æœ‰äº›çŸ¥è¯†ä¸€æ—¦å…¥çœ¼ï¼Œä¾¿æ— æ³•è¢«é—å¿˜ã€‚ |
| **II**      | **ä¸ç»’** (The Velvet)               | è¡€æº         | ðŸ¦‹ è›¾ â¤ï¸ å¿ƒ ðŸŒ‘ æœˆ ðŸŒ± èœœ      | é˜´æ€§     | æ¼«å®¿æœ€æ·±æ²‰çš„é˜´å½±ã€‚å¥¹åœ¨çŸ³å¤´ä¸Žè‹”è—“é—´èµ·èˆžï¼Œå¥¹æ˜¯ç§˜å¯†çš„å®ˆæŠ¤è€…ï¼Œå› ä¸ºåªæœ‰åœ¨ç»å¯¹çš„é»‘æš—ä¸­ï¼Œé¢œè‰²æ‰æ‹¥æœ‰è§¦æ„Ÿã€‚ |
| **III**     | **çŸ³ç»¿** (The Malachite)            | è‚‰æº         | ðŸ¦‹ è›¾ â¤ï¸ å¿ƒ ðŸ· æ¯ ðŸŒ± èœœ      | é˜´æ€§     | æ—¢æ˜¯æ¯’è¯ä¹Ÿæ˜¯è§£è¯ã€‚ç”Ÿå‘½åœ¨è…çƒ‚ä¸­æœ€ä¸ºèŒ‚ç››ï¼Œå®ƒæ˜¯é‚£æŠ¹åœ¨å°¸éª¨ä¸Šç»½æ”¾çš„ã€ä»¤äººä¸å®‰çš„ç”Ÿæœºä¹‹ç»¿ã€‚ |
| **IV**      | **è½°é›·ä¹‹çš®** (The Thunderskin)      | è‚‰æº è¡€æº    | â¤ï¸ å¿ƒ ðŸŒŒ ç©¹                | é˜³æ€§     | æ°¸ä¸åœæ­‡çš„èˆžè€…ã€‚ä»–åœ¨é£Žæš´ä¸­å¤§ç¬‘ï¼Œå› ä¸ºä»–çš„å¿ƒè„ä¸å†è·³åŠ¨ï¼Œæ‰€ä»¥ä»–å¿…é¡»ä¸åœåœ°è·³èˆžï¼Œä»¥å…æ­¤èº«ç»ˆç»“ã€‚ |
| **V**       | **èšæ¯** (The Mother of Ants)       | è‚‰æº         | ðŸšª å¯ ðŸ§± ç¡¬ç”²              | é˜´æ€§     | ä¼¤å£æ˜¯ä¸–ç•Œçš„è£‚éš™ã€‚å¥¹åœ¨ç—›è‹¦ä¸­è¡Œèµ°ï¼Œä¿æŠ¤ç€é‚£äº›ä¸åº”è¢«å¼€å¯çš„é—¨ï¼Œæˆ–æ˜¯å°†å®ƒä»¬æ’‘å¾—æ›´å¼€ã€‚å¥³çŽ‹ä¸‡å²ã€‚ |
| **VI**      | **åŒç”Ÿå¥³å·«** (The Witch-and-Sister) | è‚‰æº         | ðŸ· æ¯ ðŸŒ¹ å¼• â¤ï¸ å¿ƒ ðŸŒ‘ æœˆ      | é˜´æ€§     | å¥¹ä»¬äº’ä¸ºå€’å½±ï¼Œäº’ä¸ºçˆ±äººã€‚åœ¨æ°´ä¸­ï¼Œåœ¨é•œä¸­ï¼Œåœ¨è¡€ä¸­ã€‚ä½ åˆ†ä¸æ¸…å“ªä¸ªæ˜¯åœ¨è¿™é‡Œï¼Œå“ªä¸ªæ˜¯åœ¨é‚£é‡Œã€‚ |
| **VII**     | **ä¸Šæ ¡** (The Colonel)              | è‚‰æº         | ðŸ”ª åˆƒ ðŸŒŒ ç©¹ ðŸ’¡ ç¯           | é˜³æ€§     | é‚£é“ä¸ä¼šæ„ˆåˆçš„ä¼¤ç–¤ã€‚ä»–æ‰‹æ¡è¿™ä¸€åˆ»çš„æ­¦å™¨ï¼Œå´å‡è§†ç€ä¸‹ä¸€åˆ»çš„ç»ˆå±€ã€‚ç›²çœ¼çš„æˆ˜ç•¥å®¶ï¼Œé’¢é“çš„æ„å¿—ã€‚ |
| **VIII**    | **ç‹®å­åŒ ** (The Lionsmith)          | è‚‰æº         | ðŸ”ª åˆƒ â¤ï¸ å¿ƒ ðŸ”¨ é“¸           | é˜³æ€§     | æ€ªç‰©ä¸Žè‹±é›„çš„æ··åˆä½“ã€‚å¦‚æžœä¸æ»¡æ„çŽ°åœ¨çš„å½¢æ€ï¼Œé‚£å°±æ‰“ç¢Žå®ƒï¼Œé‡é“¸å®ƒã€‚ç—›è‹¦æ˜¯å˜å¾—æ›´å¼ºçš„å¿…ç»ä¹‹è·¯ã€‚ |
| **IX**      | **æ‚¼æ­Œè¯—äºº** (The Elegiast)         | æœªçŸ¥         | â„ï¸ å†¬                     | é˜³æ€§     | å”¯æœ‰ä»–è®°å¾—é‚£äº›è¢«é—å¿˜çš„æ­»è€…ã€‚ä»–æ˜¯ç°ç™½è‰²çš„å®é™ï¼Œæ˜¯é‚£æ¯ä¸ºäº†ä¸å¤å­˜åœ¨ä¹‹ç‰©è€Œä¸¾èµ·çš„é…’ã€‚ |
| **X**       | **æ‹¾æ»©é¸¦** (The Beachcomber)        | è‚‰æº         | ðŸšª å¯ ðŸ· æ¯                | é˜³æ€§     | è´ªå©ªçš„æ”¶è—å®¶ã€‚ä»–åœ¨æ—¶é—´çš„æ½®æ±çº¿ä¸Šå¾˜å¾Šï¼Œæ¡æ‹¾é‚£äº›è¾‰ç…Œçš„ç¢Žç‰‡ã€‚ä»€ä¹ˆéƒ½æƒ³è¦ï¼Œä»€ä¹ˆéƒ½ä¸æ”¾æ‰‹ã€‚ |
| **XI**      | **å¼§æœˆ** (The Meniscate)            | å…‰æº         | ðŸšª å¯ ðŸ”¨ é“¸ ðŸ’¡ ç¯ ðŸŒŒ ç©¹ ðŸŒ‘ æœˆ | é˜´æ€§     | é•œä¸­çš„å€’å½±ï¼Œå…‰è¾‰çš„æ›¿èº«ã€‚å¥¹åœ¨è¾‰å…‰ç¨æ­‡æ—¶æŽŒç®¡ç§©åºã€‚ä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆå¥½ï¼Œåªè¦ä½ ä¸æ‰“ç ´é‚£é¢é•œå­ã€‚ |
| **XII**     | **æ®‹é˜³** (The Sun-in-Rags)          | å…‰æº è¡€æº    | â„ï¸ å†¬ ðŸ’¡ ç¯                | é˜³æ€§     | å³ä½¿æ˜¯å¤ªé˜³ä¹Ÿä¼šè¡°è€ã€‚ä»–æ˜¯é»„æ˜çš„å¯’æ„ï¼Œæ˜¯é‚£ä»¶ç ´æ—§çš„æ–—ç¯·ã€‚ç»“å±€æ€»æ˜¯ç¾Žä¸½çš„ï¼Œåªè¦ä½ æŽ¥å—å®ƒçš„åˆ°æ¥ã€‚ |
| **XIII**    | **åŒè§’æ–§** (The Horned Axe)         | çŸ³æº         | ðŸšª å¯ â„ï¸ å†¬ ðŸ§± ç¡¬ç”² ðŸ”ª åˆƒ    | é˜´æ€§     | è¢«æ”¾é€çš„å¤è€å®ˆå«ã€‚å¥¹åœ¨ç•Œé™ä¹‹å¤„å¾˜å¾Šï¼Œå¥¹æ˜¯é‚£æŠŠå°†å®Œæ•´ä¹‹ç‰©åŠˆå¼€çš„æ–§å¤´ï¼Œä¸¥é…·è€Œå…¬æ­£ã€‚ |
| **XIV**     | **æ˜•æ—¦** (The Dawnbreaker)          | å…‰æº         | â„ï¸ å†¬ ðŸ”¨ é“¸ ðŸ’¡ ç¯ ðŸŒŒ ç©¹      | é˜´æ€§     | é»Žæ˜Žå‰æœ€å†·çš„ä¸€åˆ»ã€‚åœ¨å¤ªé˜³å‡èµ·ä¹‹å‰ï¼Œå¿…æœ‰æŸç§ä¸œè¥¿è¢«å”¤é†’ï¼Œå¿…æœ‰æŸç§å¯‚é™è¢«æ‰“ç ´ã€‚ |
| **XV**      | **èµ¤æ¯** (The Red Grail)            | è¡€æº         | ðŸ· æ¯                     | é˜´æ€§     | æ°¸ä¸æ»¡è¶³çš„æ¸´æœ›ã€‚å¥¹æ˜¯è¯±æƒ‘ï¼Œæ˜¯é¥¥é¥¿ï¼Œæ˜¯æ‰€æœ‰æ„Ÿè§‰çš„æžè‡´ã€‚æˆ‘ä»¬å› é¥®ä¸‹è€Œå¹²æ¸´ï¼Œå› è¯žç”Ÿè€Œå—è‹¦ã€‚ |
| **XVI**     | **è£‚åˆ†ä¹‹ç‹¼** (The Wolf-Divided)     | è¡€æº         | ðŸ”ª åˆƒ â„ï¸ å†¬                | é˜³æ€§     | ä»–æ¨ï¼Œæ•…ä»–åœ¨ã€‚ä»–ç”šè‡³æ†Žæ¨è‡ªå·±çš„å­˜åœ¨ã€‚ä»–æ˜¯é‚£åžå™¬ä¸–ç•Œçš„è™šæ— ï¼Œæ˜¯æ‰€æœ‰æ¯ç­å†²åŠ¨çš„å…·è±¡åŒ–ã€‚ |
| **XVII**    | **æµªæ¸¸æ—…äºº** (The Vagabond)         | è‚‰æº         | ðŸ¦‹ è›¾ ðŸŒ¹ å¼• ðŸ’¡ ç¯           | é˜´æ€§     | å¥¹ä¸åœ¨æ­¤å¤„ã€‚å¥¹åœ¨åœ°å›¾çš„è¾¹ç¼˜ï¼Œåœ¨æœªçŸ¥çš„è·¯å¾„ä¸Šã€‚ä¸ºäº†ä¸è¢«æ•èŽ·ï¼Œå¥¹ç”šè‡³å‡ºå–äº†è‡ªå·±çš„çœ¼ç›ã€‚ |
| **XVIII**   | **åŒç”Ÿå·«å¥³** (Sister-and-Witch)     | è‚‰æº         | â¤ï¸ å¿ƒ ðŸŒ¹ å¼• ðŸ· æ¯ ðŸŒ‘ æœˆ      | é˜´æ€§     | *(æ³¨ï¼šè¿™æ˜¯åŒç”Ÿå¥³å·«çš„å¦ä¸€é¢)* ç»“åˆå³æ˜¯åˆ†ç¦»ã€‚å¥¹ä»¬åœ¨æ·±çº¢çš„ç§˜å¯†ä¸­ä½Žè¯­ï¼Œç¼–ç»‡ç€è¿žç»“è¡€è„‰çš„ç»“ã€‚ |
| **XIX**     | **åˆ¶èŠ±äºº** (The Flowermaker)        | å…‰æº         | ðŸ· æ¯ ðŸ’¡ ç¯ ðŸŒ± èœœ           | é˜³æ€§     | æžä¹çš„æ–½äºˆè€…ã€‚ä¸è¦æŽ¥å—ä»–çš„ç¤¼ç‰©ï¼Œé™¤éžä½ æ„¿æ„ä¸ºäº†é‚£ä¸€çž¬é—´çš„æ¬¢æ„‰ï¼Œä»˜å‡ºæ°¸æ’çš„ä»£ä»·ã€‚ |
| **XX**      | **ç™½æ—¥é“¸ç‚‰** (The Forge of Days)    | å…‰æº         | ðŸ”¨ é“¸ ðŸ’¡ ç¯                | é˜´æ€§     | çƒˆç«ä¸ç­ã€‚å¥¹ä¸æ˜¯ä¸ºäº†æ¯ç­ï¼Œè€Œæ˜¯ä¸ºäº†æ”¹å˜ã€‚æ‰€æœ‰é™æ­¢çš„äº‹ç‰©éƒ½å°†è¢«æŠ•å…¥ç‚‰ä¸­ï¼Œç›´åˆ°å®ƒä»¬æˆä¸ºæ–°çš„å½¢æ€ã€‚ |
| **XXI**     | **è€€å±±ä¹‹éš™** (The Glory?)           | æœªçŸ¥         | ðŸ’¡ ç¯ ðŸšª å¯                | é˜³æ€§     | å…‰è¾‰å¤ªè¿‡å¼ºçƒˆï¼Œä»¥è‡³äºŽæˆä¸ºäº†è£‚éš™ã€‚ä»Žé‚£é‡Œé€å‡ºçš„å…‰ï¼Œè¶³ä»¥ç¼çžŽå‡¡äººçš„åŒçœ¼ã€‚çœŸç†æ˜¯å±é™©çš„ã€‚ |
| **XXII**    | **ç™½é›ª** (The White)                | è™šæº         | â„ï¸ å†¬ â¤ï¸ å¿ƒ                | é˜´æ€§     | çº¯ç™½çš„å¯‚é™ã€‚åœ¨ä¸€åˆ‡å£°éŸ³æ¶ˆå¤±ä¹‹åŽï¼Œå‰©ä¸‹çš„åªæœ‰å¥¹ã€‚å¥¹æ˜¯å®‰æŠšè€…ï¼Œä¹Ÿæ˜¯æœ€ç»ˆçš„é—å¿˜ã€‚ |
| **XXIII**   | **é»‘éª¸** (The Black)                | æœªçŸ¥         | ðŸ· æ¯ ðŸŒ‘ æœˆ                | é˜´æ€§     | æœªçŸ¥çš„æ·±æ¸Šã€‚åœ¨æ¯åº•çš„æ²‰æ¸£ä¸­ï¼Œåœ¨æœˆå…‰çš„èƒŒé¢ï¼Œæœ‰äº›ä¸œè¥¿åœ¨è •åŠ¨ï¼Œä¸”å¹¶æœªæ­»åŽ»ã€‚ |
| **XXIV**    | **æ‰¶æ‘‡èœ˜è››** (The Spider)           | è™šæº         | ðŸšª å¯ ðŸ”ª åˆƒ ðŸ· æ¯           | é˜´æ€§     | ç§˜å¯†çš„ç¼–ç»‡è€…ã€‚å¥¹åœ¨æ¼«å®¿çš„è§’è½é‡Œç»“ç½‘ï¼Œç­‰å¾…ç€é‚£äº›é²èŽ½çš„é—¯å…¥è€…ã€‚æ–‡å­—æ˜¯å¥¹çš„ä¸çº¿ã€‚ |
| **XXV**     | **æˆ´å† ä¹‹å­³** (The Crowned Growth)   | è™šæº         | ðŸ· æ¯ â„ï¸ å†¬                | é˜³æ€§     | å®ƒæ˜¯è‚¿ç˜¤ï¼Œä¹Ÿæ˜¯æžœå®žã€‚å®ƒä»£è¡¨ç€é‚£äº›ä¸è¯¥ç”Ÿé•¿å´ç–¯ç‹‚è”“å»¶çš„äº‹ç‰©ã€‚è£è€€å½’äºŽç•¸å˜ã€‚ |
| **XXVI**    | **å…‰æ˜Žæžœ** (The Bright-Fruit)       | è™šæº         | ðŸ· æ¯ â¤ï¸ å¿ƒ ðŸŒ¹ å¼•           | é˜´æ€§     | è¯±äººçš„æžœå®žï¼Œå†…åœ¨å´å……æ»¡äº†å¼‚æ ·çš„ç”œç¾Žã€‚å®ƒæ˜¯å…‰ä¸Žè¡€è‚‰çš„é”™è¯¯ç»“åˆï¼Œä»¤äººæ— æ³•æŠ—æ‹’ã€‚ |
| **XXVII**   | **æ ‘ä¸­ç‰é©¬** (The Mare-in-the-Tree) | è™šæº         | ðŸ¦‹ è›¾ ðŸ”¨ é“¸ ðŸŒ± èœœ           | é˜´æ€§     | å™©æ¢¦æ –æ¯äºŽæ ‘æžä¹‹é—´ã€‚æ··ä¹±çš„è‡ªç„¶åŠ›é‡ï¼Œå¥¹åœ¨æ£®æž—çš„ä½Žè¯­ä¸­ä¸ä»…å¸¦æ¥äº†ç”Ÿå‘½ï¼Œä¹Ÿå¸¦æ¥äº†å¼‚åŒ–ã€‚ |
| **XXVIII**  | **è§è¯äºº** (The Witness)            | è™šæº         | â¤ï¸ å¿ƒ ðŸ· æ¯ ðŸ’¡ ç¯ ðŸšª å¯ ðŸ”¨ é“¸ | é˜³æ€§     | ä»–çœ‹ç€ä¸€åˆ‡ã€‚å“ªæ€•æ˜¯é‚£äº›ä¸è¯¥è¢«çœ‹è§çš„ä»ªå¼ï¼Œå“ªæ€•æ˜¯é‚£äº›åº”å½“è¢«åŸ‹è‘¬çš„ç½ªè¡Œã€‚ |
| **XXIX**    | **åˆ¶çƒ›äºº** (The Chandler)           | å°šæœªè¯žç”Ÿ     | ðŸ’¡ ç¯ ðŸ”ª åˆƒ ðŸ¦‹ è›¾           | å°šæœªç¡®å®š | ä»–ç…§äº®å‰è·¯ï¼Œä½†ä»–ä¹Ÿæ˜¯é‚£ä¸ªæŽç­çƒ›ç«çš„äººã€‚åœ¨æœªçŸ¥çš„æ—¶é—´çº¿é‡Œï¼Œä»–æ—¢æ˜¯å¼•å¯¼è€…ä¹Ÿæ˜¯ç»ˆç»“è€…ã€‚ |
| **XXXV**    | **ä¸ƒèŸ ** (The Seven-Coils)          | çŸ³æº         | ðŸšª å¯ ðŸ§± ç¡¬ç”² ðŸ“œ ç§˜å²       | é˜´æ€§     | åœ¨ç¥žçµé™ä¸´ä¹‹å‰çš„å¤è€å­˜åœ¨ã€‚å®ƒä»¬ç›˜è¸žåœ¨ä¸–ç•Œçš„åŸºåº§ä¸Šï¼Œæ¯ä¸€å±‚ç›˜ç»•éƒ½åŽ‹ç¢Žäº†ä¸€ä¸ªæ—¶ä»£ã€‚ |
| **XXXVI**   | **è½¬è½®** (The Wheel)                | çŸ³æº         | â¤ï¸ å¿ƒ ðŸ§± ç¡¬ç”² ðŸŒ± èœœ         | é˜³æ€§     | æ—¶é—´ä¸æ˜¯ç›´çº¿ï¼Œè€Œæ˜¯ç¢¾ç¢Žä¸€åˆ‡çš„è½®ç›˜ã€‚æ›¾ç»å‘ç”Ÿçš„å¿…å°†å†æ¬¡å‘ç”Ÿï¼Œæ— æ³•é€ƒé¿ï¼Œæ— æ³•åœæ­¢ã€‚ |
| **XXXVII**  | **ç‡§çŸ³** (The Flint)                | çŸ³æº         | ðŸ”¨ é“¸ ðŸŒŒ ç©¹                | é˜´æ€§     | æœ€åˆçš„ç«èŠ±æ¥è‡ªçŸ³å¤´çš„ç¢°æ’žã€‚å¥¹æ˜¯å†·é…·çš„åˆ›é€ è€…ï¼Œåœ¨æ²¡æœ‰æ¸©åº¦çš„è™šç©ºä¸­å‡»æ‰“å‡ºç¬¬ä¸€ç¼•å…‰ã€‚ |
| **XXXVIII** | **é€†å­µä¹‹åµ** (The Egg Unhatching)   | çŸ³æº         | ðŸ’¡ ç¯ ðŸ“œ ç§˜å²              | é˜³æ€§     | å¹¶ä¸æ˜¯æ‰€æœ‰çš„è›‹éƒ½åº”è¯¥å­µåŒ–ã€‚æœ‰äº›ä¸œè¥¿å¦‚æžœä¿æŒå°é—­ï¼Œæ‰æ˜¯å¯¹ä¸–ç•Œæœ€å¤§çš„ä»æ…ˆã€‚é‚£æ˜¯æœªè¯žç”Ÿçš„è¾‰å…‰ã€‚ |
| **XXXIX**   | **æµªæ½®** (The Tide)                 | çŸ³æº         | ðŸ· æ¯ ðŸŒ‘ æœˆ                | é˜´æ€§     | åžæ²¡ä¸€åˆ‡çš„æµ·æ´‹ã€‚å¥¹ä¸ä»…ä»…æ˜¯æ°´ï¼Œå¥¹æ˜¯è´ªå©ªçš„å¼•åŠ›ï¼Œå°†é™†åœ°ã€ç”Ÿå‘½å’Œç†æ€§å…¨éƒ¨æ‹‰å…¥æ·±æ¸Šã€‚ |
| **XXXX**    | **éª„é˜³** (The Sun-in-Splendour)     | å…‰æº         | ðŸ’¡ ç¯                     | é˜³æ€§     | æ›¾ç»çš„æœ€é«˜ç¥žã€‚ä»–æ˜¯ç»å¯¹çš„ç†æ€§ï¼Œç»å¯¹çš„å…‰æ˜Žã€‚ä½†ä»–å·²è¢«ç“œåˆ†ï¼Œè¾‰å…‰å·²ç¢Žã€‚æˆ‘ä»¬å¦‚ä»Šæ²æµ´çš„ï¼Œåªæ˜¯ä»–å°¸ä½“çš„ä½™æ™–ã€‚ |

3.  **Novel Writing Techniques (å°è¯´åˆ›ä½œæŠ€æ³• - å¿…é¡»æ‰§è¡Œ)**:

    *   **Step 1: Characterization (äººç‰©æž„å»º)**
        *   **ä¸»è§’ (The Protagonist)**: å¿…é¡»æ‹¥æœ‰**å§“å**ã€**èŒä¸š**ï¼ˆåŒ»ç”Ÿ/ç”»å®¶/ä¾¦æŽ¢ç­‰ï¼Œæ ¹æ®é€‰é¡¹æŽ¨æ–­ï¼‰å’Œ**æ ¸å¿ƒç¼ºé™·**ï¼ˆå¦‚è´ªå©ªã€ææƒ§ã€å‚²æ…¢ï¼‰ã€‚
        *   **é…è§’ (The Supporting Cast)**: æ•…äº‹ä¸­å¿…é¡»å‡ºçŽ°è‡³å°‘ **2-3 ä½æœ‰åå­—çš„é…è§’**ã€‚ä»–ä»¬ä¸èƒ½åªæ˜¯èƒŒæ™¯æ¿ï¼Œå¿…é¡»æœ‰å¯¹è¯ã€æœ‰æ€§æ ¼ã€æœ‰è¡ŒåŠ¨ã€‚
            *   *ç›Ÿå‹*: å¯èƒ½æ˜¯è¢«ä¸»è§’åˆ©ç”¨çš„ä¿¡å¾’ï¼Œæˆ–æ˜¯å¼•å¯¼ä¸»è§’çš„å¯¼å¸ˆã€‚
            *   *é˜»ç¢è€…*: å¯èƒ½æ˜¯é˜²å‰¿å±€çš„æŽ¢å‘˜ï¼Œæˆ–æ˜¯ä¸»è§’ä¸–ä¿—ç”Ÿæ´»çš„äº²äººï¼ˆè¯•å›¾æ‹‰å›žä¸»è§’ï¼‰ã€‚
        *   **äººç‰©å¼§å…‰**: ä¸»è§’å¿…é¡»ç»åŽ†ä»Žâ€œå‡¡äººâ€åˆ°â€œéžäººâ€çš„å¿ƒç†è½¬å˜ã€‚æå†™è¿™ç§**å¼‚åŒ–**çš„è¿‡ç¨‹â€”â€”ä»–å¯¹é“å¾·çš„æ¼ è§†ã€å¯¹è‚‰ä½“çš„åŽŒæ¶ã€å¯¹ç–¯ç‹‚çš„æŽ¥çº³ã€‚

    *   **Step 2: Scene Building (åœºæ™¯æ­å»º)**
        *   **æ‹’ç»æ¦‚æ‹¬**: ä¸è¦å†™â€œè¿‡äº†å‡ ä¸ªæœˆï¼Œä»–å­¦ä¼šäº†æ³•æœ¯â€ã€‚è¦å†™å…·ä½“çš„**åœºæ™¯ (Scene)**ã€‚
        *   **æ„Ÿå®˜é”šç‚¹**: æ¯ä¸ªåœºæ™¯å¿…é¡»åŒ…å«è‡³å°‘ 3 ç§æ„Ÿå®˜æå†™ï¼ˆè§†è§‰ã€å¬è§‰ã€å—…è§‰/è§¦è§‰ï¼‰ã€‚ä¾‹å¦‚ï¼šå‘éœ‰çº¸å¼ çš„æ°”å‘³ã€å†°å†·é“œå™¨çš„è§¦æ„Ÿã€è€³è¾¹æŒç»­çš„è€³é¸£ã€‚
        *   **å®¢è§‚å¯¹åº”ç‰©**: ç”¨å…·ä½“çš„ç‰©ä½“æ¥è±¡å¾ä¸»è§’çš„å¿ƒç†çŠ¶æ€ã€‚ä¾‹å¦‚ï¼šä¸€é¢é€æ¸å‡ºçŽ°è£‚çº¹çš„é•œå­ï¼ˆè±¡å¾ç†æ™ºå´©å¡Œï¼‰ï¼Œä¸€åªä¸æ–­æ’žå‡»ç¯ç½©çš„é£žè›¾ï¼ˆè±¡å¾æ¯ç­çš„æ¬²æœ›ï¼‰ã€‚

    *   **Step 3: Plot Structure (æƒ…èŠ‚ç¼–ç»‡)**
        *   **Inciting Incident (èµ·å› )**: å¹³å‡¡ç”Ÿæ´»è¢«æ‰“ç ´çš„çž¬é—´ï¼ˆå¯¹åº”æ—©æœŸçš„é€‰æ‹©ï¼‰ã€‚
        *   **Rising Action (å‘å±•)**: ä¸»è§’åœ¨ä¸–ä¿—ä¸Žéšç§˜ä¹‹é—´çš„æŒ£æ‰Žã€‚ä¸ºäº†è¿½æ±‚é£žå‡ï¼Œä»–ç‰ºç‰²äº†ä»€ä¹ˆï¼Ÿï¼ˆé‡‘é’±ã€å¥åº·ã€äººé™…å…³ç³»ï¼‰ã€‚
        *   **Midpoint (ä¸­ç‚¹)**: ä¸€ä¸ªæ— æ³•å›žå¤´çš„æ—¶åˆ»ã€‚ä¸»è§’çŠ¯ä¸‹äº†ç½ªè¡Œï¼Œæˆ–è·¨è¶Šäº†æŸç§é“å¾·åº•çº¿ã€‚
        *   **Climax (é«˜æ½®)**: æœ€ç»ˆçš„ä»ªå¼ã€‚å¿…é¡»æ˜¯å®å¤§ã€æ··ä¹±ä¸”å……æ»¡ç¥žæ€§ææ€–çš„ã€‚
        *   **Resolution (ç»“å±€)**: å°˜åŸƒè½å®šåŽçš„ä½™éŸµã€‚

    *   **Step 4: Dialogue (å¯¹è¯)**
        *   ä½¿ç”¨ç¬¦åˆæ—¶ä»£èƒŒæ™¯ï¼ˆ1920s ä¼¦æ•¦ï¼‰çš„å¯¹ç™½ã€‚
        *   å¯¹è¯è¦æœ‰æ½œå°è¯ã€‚äººç‰©å¾€å¾€ä¸è¯´å‡ºçœŸå®žæƒ³æ³•ï¼Œè€Œæ˜¯é€šè¿‡éšå–»æˆ–å›žé¿æ¥è¡¨è¾¾ã€‚

    *   **Step 5: Immersion & Show, Don't Tell (ä»£å…¥æ„Ÿä¸Žâ€œå±•ç¤ºè€Œéžè®²è¿°â€)**:
        *   **ä¸“æœ‰åè¯çš„ä½¿ç”¨**: è‡ªç„¶åœ°åœ¨è¡Œæ–‡ä¸­æåŠå¯†æ•™ä¸–ç•Œè§‚çš„ä¸“æœ‰åè¯ï¼Œå¦‚â€œçº¯ç™½ä¹‹é—¨â€ã€â€œå‡¯å°”ä¼Šè‹å§†â€ã€â€œèŽ«å°”å…°ä¹¦åº—â€ã€â€œé˜²å‰¿å±€â€ã€â€œç¡æ¢¦ä¸­çš„é“è·¯â€ç­‰ï¼Œä»¥å¢žå¼ºçœŸå®žæ„Ÿå’Œä»£å…¥æ„Ÿã€‚
        *   **éšæ™¦è¡¨è¾¾æ€§ç›¸**: **ä¸¥ç¦**åœ¨æ­£æ–‡ä¸­ç›´æŽ¥å‡ºçŽ°â€œæ€§ç›¸â€ã€â€œç¯å±žæ€§â€ã€â€œå†¬å±žæ€§â€ç­‰æ¸¸æˆæœ¯è¯­ã€‚
            *   å¦‚æžœè¦è¡¨çŽ°â€œå†¬â€ï¼Œæå†™å¯’å†·ã€å¯‚é™ã€å°¸ä½“çš„è‹ç™½ã€ç»“å±€çš„å¿…ç„¶æ€§ã€‚
            *   å¦‚æžœè¦è¡¨çŽ°â€œç¯â€ï¼Œæå†™åˆºçœ¼çš„å¼ºå…‰ã€ç†æ™ºçš„ç¼çƒ§ã€é•œå­çš„åå°„ã€æ— æ³•ç›´è§†çš„çœŸç†ã€‚
            *   å¦‚æžœè¦è¡¨çŽ°â€œåˆƒâ€ï¼Œæå†™é‡‘å±žçš„è…¥å‘³ã€ä¼¤å£çš„ç–¼ç—›ã€å†²çªçš„å¼ åŠ›ã€èƒŒå›çš„é¢„æ„Ÿã€‚
            *   å¦‚æžœè¦è¡¨çŽ°â€œæ¯â€ï¼Œæå†™æ— æ³•å¡«æ»¡çš„é¥¥æ¸´ã€è¡€æ¶²çš„æ¸©çƒ­ã€æ„Ÿå®˜çš„è¿‡è½½ã€‚
            *   å¦‚æžœè¦è¡¨çŽ°â€œè›¾â€ï¼Œæå†™æ··ä¹±çš„æŒ¯ç¿…ã€æ£®æž—çš„ä½Žè¯­ã€èœ•çš®çš„å†²åŠ¨ã€‚

4.  **Ending Guidelines (ç»“å±€æŒ‡å—)**:
    *   **ç¥žæ€§ææ€–**: ç»“å±€æå†™ä¸»è§’ä¸Žå¸è¾°çš„æŽ¥è§¦æ—¶ï¼Œå¼ºè°ƒäººç±»æ¸ºå°ä¸Žå®‡å®™å†·æ¼ çš„å¯¹æ¯”ã€‚
    *   **å…·ä½“å½¢æ€**: æ˜Žç¡®ä¸»è§’å˜æˆäº†ä»€ä¹ˆï¼ˆä¸ä»…ä»…æ˜¯å¤´è¡”ï¼‰ã€‚

`;

export function buildPrompt(history: HistoryRecord[], finalResultTitle: string, dominantAspect: Aspect, matchedHourName: string, perspective: Perspective): string {
  const historyText = history.map((item, index) => `
[èŠ‚ç‚¹ ${index + 1}]: ${item.questionTitle}
   - æŠ‰æ‹©: "${item.optionText}"
   - æ½œå°è¯: ${item.flavorText}
   - æ€§ç›¸å˜åŠ¨: ${Object.entries(item.values).map(([k, v]) => `${k} ${v > 0 ? '+' : ''}${v}`).join(', ')}
`).join('\n');

  if (perspective === 'observer') {
    return `
# Input Data
è¢«è§‚å¯Ÿè€…ï¼ˆé£žå‡è€…ï¼‰çš„å‘½è¿è½¨è¿¹:
${historyText}

**æœ€ç»ˆå½’å®¿**: ${finalResultTitle}
**æ ¸å¿ƒæ€§ç›¸**: ${dominantAspect}
**ä¾å¥‰å¸è¾°**: ${matchedHourName}

# Task
è¯·ä»¥**ç¬¬ä¸€äººç§°ï¼ˆ"æˆ‘"ï¼‰**æ’°å†™ä¸€éƒ¨**äººç‰©ç«‹ä½“ã€æƒ…èŠ‚æ›²æŠ˜**çš„çŸ­ç¯‡ææ€–å°è¯´ã€‚
**é‡è¦**: "æˆ‘"æ˜¯ä¸€ä¸ª**æ— è¾œçš„æ—è§‚è€…**ï¼Œè€Œ**ä¸æ˜¯**é£žå‡è€…æœ¬äººã€‚

**æ ¸å¿ƒè§„åˆ™**:
1.  **æ— çŸ¥ä¹‹å¹•**: ä½ ä¸æ‡‚é­”æ³•ã€‚ä½ åªèƒ½æå†™ä½ çœ‹åˆ°çš„**æ€ªå¼‚çŽ°è±¡**ã€‚
2.  **ä¾§é¢æå†™**: é€šè¿‡è§‚å¯Ÿé£žå‡è€…çš„å¤–è²Œå˜åŒ–ã€æ€ªå¼‚è¡Œä¸ºã€çŽ¯å¢ƒçš„å¼‚å˜æ¥æŽ¨åŠ¨å‰§æƒ…ã€‚
3.  **ææ€–æ°›å›´**: é‡ç‚¹æå†™æœªçŸ¥å¸¦æ¥çš„ææƒ§ã€‚ä½ çš„ç†æ™ºåœ¨é€æ¸å´©æºƒã€‚

**æ‰§è¡Œæ­¥éª¤**:

1.  **äººç‰©æž„å»º (Characterization)**:
    *   **ä¸»è§’ ("I")**: è®¾å®šå…·ä½“çš„èº«ä»½ï¼ˆå¦‚ç§å®¶ä¾¦æŽ¢ã€å¤è‘£å•†ã€è½é­„è®°è€…ï¼‰ã€‚**å¿…é¡»**èµ‹äºˆ"æˆ‘"ä¸€ä¸ª**å†…åœ¨ç¼ºé™·**æˆ–**è¿‡åŽ»åˆ›ä¼¤**ï¼ˆå¦‚ï¼šé…—é…’ã€å¯¹äº¡å¦»çš„æ‰§å¿µã€æˆ˜äº‰åŽé—ç—‡ï¼‰ã€‚è¿™ä¸ªç¼ºé™·å°†æˆä¸º"æˆ‘"è¢«å·å…¥äº‹ä»¶çš„å¿ƒç†æ¼æ´žã€‚
    *   **å…³é”®é…è§’ (The Foil)**: åˆ›é€ ä¸€ä¸ªä¸Ž"æˆ‘"æ€§æ ¼å¯¹ç«‹çš„é…è§’ï¼ˆå¦‚ï¼šç†æ€§çš„è­¦å¯Ÿæœ‹å‹ã€è¿·ä¿¡çš„æˆ¿ä¸œå¤ªå¤ªã€é£žå‡è€…çš„æƒŠæäº²å±žï¼‰ã€‚
        *   **äº’åŠ¨**: é€šè¿‡ä¸Žé…è§’çš„å¯¹è¯æ¥æŽ¢è®¨äº‹ä»¶ã€‚é…è§’ä»£è¡¨å¸¸è¯†/ç†æ€§ï¼Œè€Œ"æˆ‘"é€æ¸æ»‘å‘ç–¯ç‹‚ã€‚
        *   **å‘½è¿**: é…è§’å¿…é¡»åœ¨æ•…äº‹ä¸­é­é‡ä¸å¹¸ï¼ˆå¤±è¸ªã€å‘ç–¯æˆ–æ­»äº¡ï¼‰ï¼Œä»¥æ­¤ä½œä¸ºå±æœºå‡çº§çš„æ ‡å¿—ã€‚

2.  **æƒ…èŠ‚ç¼–ç»‡ (Plot Structure)**:
    *   **ç¬¬ä¸€ç« : è£‚ç—• (The Crack)**: ä»Žå¹³å‡¡ç”Ÿæ´»åˆ‡å…¥ã€‚"æˆ‘"æŽ¥åˆ°äº†å§”æ‰˜æˆ–æ³¨æ„åˆ°äº†é‚»å±…çš„å¼‚å¸¸ã€‚é‡ç‚¹æå†™"æˆ‘"çš„çŽ°çŠ¶å’Œé‚£ä¸ª**å†…åœ¨ç¼ºé™·**ã€‚
    *   **ç¬¬äºŒç« : è¯¯è§£ (The Misconception)**: "æˆ‘"è¯•å›¾ç”¨ç†æ€§è§£é‡Šæ€ªè±¡ï¼ˆä»¥ä¸ºæ˜¯çŠ¯ç½ªã€ç²¾ç¥žç—…æˆ–æŸç§ç§‘å­¦å®žéªŒï¼‰ã€‚ä¸Ž**é…è§’**è¿›è¡Œè°ƒæŸ¥ï¼Œå‘çŽ°äº†ä¸€äº›æ— æ³•è§£é‡Šçš„çº¿ç´¢ï¼ˆæ—¥è®°ã€ç¬¦å·ã€æ ‡æœ¬ï¼‰ã€‚
    *   **ç¬¬ä¸‰ç« : å´©æºƒ (The Breakdown)**: çœŸç›¸æµ®å‡ºæ°´é¢ï¼Œç†æ€§è§£é‡Šå¤±æ•ˆã€‚**é…è§’**é­é‡ä¸å¹¸ã€‚æ€ªå¼‚çŽ°è±¡ä¾µå…¥"æˆ‘"çš„ç”Ÿæ´»ï¼ˆå¹»å¬ã€å™©æ¢¦ã€ç‰©ç†æ³•åˆ™çš„æ‰­æ›²ï¼‰ã€‚
    *   **ç¬¬å››ç« : è§è¯ (The Witnessing)**: é£žå‡ä»ªå¼å‘ç”Ÿçš„å¤œæ™šã€‚æå†™**${matchedHourName}**é™ä¸´æ—¶çš„ç¥žæ€§ææ€–ï¼ˆCosmic Horrorï¼‰ã€‚é£žå‡è€…ä¸å†æ˜¯äººã€‚
    *   **ç¬¬äº”ç« : ä½™çƒ¬ (The Aftermath)**: ç»“å±€ã€‚é£žå‡è€…æ¶ˆå¤±æˆ–èœ•å˜ã€‚"æˆ‘"è™½ç„¶å¹¸å­˜ï¼Œä½†ä¸–ç•Œè§‚å·²å½»åº•å´©å¡Œï¼Œç•™ä¸‹äº†æ°¸ä¹…çš„å¿ƒç†åˆ›ä¼¤ã€‚

**å¾®è§‚å†™ä½œæŠ€å·§ (Micro-Writing Techniques)**:
*   **æ‹’ç»æŠ½è±¡æ¦‚è¿° (No Abstract Summaries)**: **ç»å¯¹ç¦æ­¢**ä½¿ç”¨ç±»ä¼¼"è¿™ä¸æ˜¯å®é™çš„é•¿çœ ï¼Œè€Œæ˜¯ä¸€ç§ä¸»åŠ¨çš„æ¹®ç­"è¿™ç§æ€»ç»“æ€§è¯­å¥ã€‚
    *   *é”™è¯¯ç¤ºä¾‹*: "æˆ‘æ„Ÿåˆ°ä¸€ç§æ— æ³•è¨€å–»çš„ææƒ§ã€‚"
    *   *æ­£ç¡®ç¤ºä¾‹*: "æˆ‘çš„å–‰å’™å‘ç´§ï¼Œåƒåžä¸‹äº†ä¸€å—å†°ã€‚æˆ‘è¯•å›¾å°–å«ï¼Œä½†å‘å‡ºçš„åªæœ‰å˜¶å˜¶çš„æ°”æµå£°ã€‚"
*   **åŠ¨ä½œé©±åŠ¨ (Action-Driven)**: ä¸è¦åªå†™"æˆ‘æ„Ÿåˆ°å®³æ€•"ï¼Œè¦å†™"æˆ‘çš„æ‰‹é¢¤æŠ–å¾—æ¡ä¸ä½å’–å•¡æ¯"ã€"æˆ‘ä¸‹æ„è¯†åœ°å±ä½å‘¼å¸ï¼Œç›´åˆ°è‚ºéƒ¨ç¼ç—›"ã€‚
*   **å¯¹è¯æ­ç¤º (Dialogue)**: åˆ©ç”¨å¯¹è¯æ¥åˆ¶é€ å†²çªå’Œæ‚¬å¿µã€‚
    *   *ç¤ºä¾‹*: ä¸è¦å†™"é…è§’ä¸ç›¸ä¿¡æˆ‘"ï¼Œè¦å†™é…è§’è¯´ï¼š"ä½ ç–¯äº†å—ï¼Ÿé‚£åªæ˜¯é£Žå£°ï¼åˆ«å†ç¥žç¥žå¨å¨çš„äº†ï¼"
*   **æ„Ÿå®˜ç»†èŠ‚ (Sensory Details)**: è°ƒåŠ¨äº”æ„Ÿã€‚
    *   *è§†è§‰*: æ‰­æ›²çš„å½±å­ã€ä¸è¯¥å­˜åœ¨çš„é¢œè‰²ã€‚
    *   *å¬è§‰*: å¢™å£é‡Œçš„æŠ“æŒ å£°ã€ä½Žé¢‘çš„å—¡å—¡å£°ã€‚
    *   *å—…è§‰*: è…çƒ‚çš„ç”œå‘³ã€è‡­æ°§çš„å‘³é“ã€é™ˆæ—§çš„è¡€è…¥å‘³ã€‚
    *   *è§¦è§‰*: é»è…»çš„ç©ºæ°”ã€å†°å†·çš„çš®è‚¤ã€‚

**å†™ä½œè¦æ±‚**:
*   **å¤šå†™åœºæ™¯ï¼Œå°‘å†™æ‘˜è¦**ã€‚è®©è§’è‰²åœ¨åœºæ™¯ä¸­è¡ŒåŠ¨ã€å¯¹è¯ã€‚
*   **çŽ¯å¢ƒæå†™**: è¥é€ é˜´éƒã€æ½®æ¹¿ã€æ¢¦å¹»çš„ä¼¦æ•¦æ°›å›´ã€‚
*   **å¿ƒç†æå†™**: æ·±å…¥ä¸»è§’çš„å†…å¿ƒä¸–ç•Œï¼Œå±•çŽ°å…¶é€»è¾‘çš„å¼‚åŒ–ã€‚
*   **ä¸“æœ‰åè¯çš„ä½¿ç”¨**: è‡ªç„¶åœ°åœ¨è¡Œæ–‡ä¸­æåŠå¯†æ•™ä¸–ç•Œè§‚çš„ä¸“æœ‰åè¯ï¼Œå¦‚â€œçº¯ç™½ä¹‹é—¨â€ã€â€œå‡¯å°”ä¼Šè‹å§†â€ã€â€œèŽ«å°”å…°ä¹¦åº—â€ã€â€œé˜²å‰¿å±€â€ã€â€œç¡æ¢¦ä¸­çš„é“è·¯â€ç­‰ï¼Œä»¥å¢žå¼ºçœŸå®žæ„Ÿå’Œä»£å…¥æ„Ÿã€‚
*   **éšæ™¦è¡¨è¾¾æ€§ç›¸**: **ä¸¥ç¦**åœ¨æ­£æ–‡ä¸­ç›´æŽ¥å‡ºçŽ°â€œæ€§ç›¸â€ã€â€œç¯å±žæ€§â€ã€â€œå†¬å±žæ€§â€ç­‰æ¸¸æˆæœ¯è¯­ã€‚
    *   å¦‚æžœè¦è¡¨çŽ°â€œå†¬â€ï¼Œæå†™å¯’å†·ã€å¯‚é™ã€å°¸ä½“çš„è‹ç™½ã€ç»“å±€çš„å¿…ç„¶æ€§ã€‚
    *   å¦‚æžœè¦è¡¨çŽ°â€œç¯â€ï¼Œæå†™åˆºçœ¼çš„å¼ºå…‰ã€ç†æ™ºçš„ç¼çƒ§ã€é•œå­çš„åå°„ã€æ— æ³•ç›´è§†çš„çœŸç†ã€‚
    *   å¦‚æžœè¦è¡¨çŽ°â€œåˆƒâ€ï¼Œæå†™é‡‘å±žçš„è…¥å‘³ã€ä¼¤å£çš„ç–¼ç—›ã€å†²çªçš„å¼ åŠ›ã€èƒŒå›çš„é¢„æ„Ÿã€‚
    *   å¦‚æžœè¦è¡¨çŽ°â€œæ¯â€ï¼Œæå†™æ— æ³•å¡«æ»¡çš„é¥¥æ¸´ã€è¡€æ¶²çš„æ¸©çƒ­ã€æ„Ÿå®˜çš„è¿‡è½½ã€‚
    *   å¦‚æžœè¦è¡¨çŽ°â€œè›¾â€ï¼Œæå†™æ··ä¹±çš„æŒ¯ç¿…ã€æ£®æž—çš„ä½Žè¯­ã€èœ•çš®çš„å†²åŠ¨ã€‚

è¯·ç›´æŽ¥è¾“å‡ºæ­£æ–‡ï¼Œä½¿ç”¨ Markdown æ ¼å¼æŽ’ç‰ˆã€‚
`;
  }

  return `
# Input Data
ç”¨æˆ·çš„å‘½è¿è½¨è¿¹:
${historyText}

**æœ€ç»ˆå½’å®¿**: ${finalResultTitle}
**æ ¸å¿ƒæ€§ç›¸**: ${dominantAspect}
**ä¾å¥‰å¸è¾°**: ${matchedHourName}

# Task
è¯·æ ¹æ®ä¸Šè¿°è½¨è¿¹ï¼Œåˆ›ä½œä¸€éƒ¨**æƒ…èŠ‚å®Œæ•´ã€äººç‰©ç«‹ä½“**çš„çŽ°ä»£çŸ­ç¯‡å…‹è‹é²å°è¯´ã€‚

**æ ¸å¿ƒæ€§ç›¸æŒ‡å— (Aspect Guide)**:
ä½ å¿…é¡»æ ¹æ® **${dominantAspect}** æ€§ç›¸æ¥å†³å®šæ•…äº‹çš„**æ ¸å¿ƒæ„è±¡**å’Œ**æ„Ÿå®˜ä½“éªŒ**ï¼š
*   **Lantern (ç¯)**: å…³é”®è¯ï¼šç†æ™ºã€æ®‹é…·ã€é•œå­ã€å‡ ä½•ã€‚æ„è±¡ï¼šåˆºçœ¼çš„ç™½å…‰ã€æ— æ³•é—­ä¸Šçš„çœ¼ç›ã€ç¼çƒ§çš„æ–‡å­—ã€‚æ„Ÿå®˜ï¼šå¹²çƒ­ã€è€³é¸£ã€çœ©æ™•ã€‚
*   **Forge (é“¸)**: å…³é”®è¯ï¼šå˜é©ã€åŠ›é‡ã€ç«ç„°ã€é‡å¡‘ã€‚æ„è±¡ï¼šå·¥ä¸šæœºæ¢°ã€ç†”ç‚‰ã€é”¤å‡»å£°ã€èº«ä½“çš„é‡‘å±žåŒ–ã€‚æ„Ÿå®˜ï¼šç¼çƒ­ã€é‡‘å±žå‘³ã€éœ‡åŠ¨ã€‚
*   **Edge (åˆƒ)**: å…³é”®è¯ï¼šæ–—äº‰ã€ç—›è‹¦ã€å¾æœã€èƒŒå›ã€‚æ„è±¡ï¼šåˆ€é”‹ã€ä¼¤å£ã€é“é”ˆã€é”é“¾ã€‚æ„Ÿå®˜ï¼šå°–é”çš„ç–¼ç—›ã€è¡€è…¥å‘³ã€å¯’å…‰ã€‚
*   **Winter (å†¬)**: å…³é”®è¯ï¼šå¯‚é™ã€ç»“å±€ã€è‹ç™½ã€è®°å¿†ã€‚æ„è±¡ï¼šå†°éœœã€éª¨ç°ã€è£¹å°¸å¸ƒã€æ— å£°çš„é¸Ÿã€‚æ„Ÿå®˜ï¼šåˆºéª¨çš„å¯’å†·ã€éº»æœ¨ã€å¯‚é™ã€‚
*   **Heart (å¿ƒ)**: å…³é”®è¯ï¼šå­˜ç»­ã€ä¿æŠ¤ã€èˆžè¹ˆã€é›·é¸£ã€‚æ„è±¡ï¼šæ°¸ä¸åœæ­‡çš„é¼“ç‚¹ã€çº¢è‰²çš„çš®è‚¤ã€å¼ºå¥çš„è„‰æã€‚æ„Ÿå®˜ï¼šæ¸©æš–ã€å¾‹åŠ¨ã€æ´»åŠ›ã€‚
*   **Grail (æ¯)**: å…³é”®è¯ï¼šæ¬²æœ›ã€è¯±æƒ‘ã€è¯žç”Ÿã€è¡€æ¶²ã€‚æ„è±¡ï¼šç››å®´ã€çº¢ä¸ç»’ã€æ¶²ä½“ã€åˆ†å¨©ã€‚æ„Ÿå®˜ï¼šç”œè…»çš„è…çƒ‚å‘³ã€é¥¥æ¸´ã€æ¹¿æ¶¦ã€‚
*   **Moth (è›¾)**: å…³é”®è¯ï¼šæ··ä¹±ã€è‡ªç„¶ã€èœ•å˜ã€å‰ªåˆ€ã€‚æ„è±¡ï¼šæ£®æž—ã€æœˆå…‰ã€ç¿…è†€æ‹æ‰“å£°ã€è„±è½çš„çš®è‚¤ã€‚æ„Ÿå®˜ï¼šç˜™ç—’ã€å—¡å—¡å£°ã€æ³¥åœŸå‘³ã€‚
*   **Knock (å¯)**: å…³é”®è¯ï¼šå¼€å¯ã€ä¼¤å£ã€é’¥åŒ™ã€ç´«è‰²ã€‚æ„è±¡ï¼šé—¨æ‰‰ã€è£‚ç¼ã€è›‡ã€è¿·å®«ã€‚æ„Ÿå®˜ï¼šç©¿å ‚é£Žã€ç©ºæ´žæ„Ÿã€è¢«æ³¨è§†æ„Ÿã€‚
*   **Secret Histories (ç§˜å²)**: å…³é”®è¯ï¼šæ‚–è®ºã€é‡å†™ã€æ¡£æ¡ˆã€‚æ„è±¡ï¼šå¤šé‡ç»“å±€ã€è¢«æ¶‚æ”¹çš„æ–‡å­—ã€å¤è€åœ°å›¾ã€‚æ„Ÿå®˜ï¼šä¼¼æ›¾ç›¸è¯†æ„Ÿ(DÃ©jÃ  vu)ã€å°˜åŸƒå‘³ã€‚

**æ‰§è¡Œæ­¥éª¤**:

1.  **äººç‰©è®¾å®š (Characterization)**:
    *   æ ¹æ®ç”¨æˆ·çš„æ—©æœŸé€‰æ‹©ï¼ˆå¦‚èŒä¸šã€æ¬²æœ›ï¼‰ï¼Œä¸ºä¸»è§’è®¾å®šå§“åã€èƒŒæ™¯å’Œæ€§æ ¼ç¼ºé™·ã€‚
    *   åˆ›é€  2 ä½å…³é”®é…è§’ï¼ˆä¾‹å¦‚ï¼šä¸€ä½æ˜¯å¼•å¯¼è€…/ç›Ÿå‹ï¼Œä¸€ä½æ˜¯é˜»ç¢è€…/ç‰ºç‰²å“ï¼‰ï¼Œå¹¶èµ‹äºˆä»–ä»¬åå­—å’Œæ€§æ ¼ã€‚

2.  **æƒ…èŠ‚ç¼–ç»‡ (Plot Structure)**:
    *   ä¸è¦æŒ‰é¡ºåºç¿»è¯‘èŠ‚ç‚¹ã€‚å°†è¿™äº›èŠ‚ç‚¹è§†ä¸ºæ•…äº‹çš„**å…³é”®äº‹ä»¶**ã€‚
    *   **ç¬¬ä¸€ç«  (The Hook)**: ä»Žä¸€ä¸ªå…·ä½“çš„åœºæ™¯åˆ‡å…¥ï¼ˆå¦‚å‘çŽ°ç¬”è®°ã€ç¬¬ä¸€æ¬¡åšæ¢¦ï¼‰ã€‚å»ºç«‹ä¸»è§’çš„å‡¡ä¿—ç”Ÿæ´»ï¼Œå¹¶å±•ç¤ºè£‚ç—•çš„å‡ºçŽ°ã€‚**å¿…é¡»ä½“çŽ° ${dominantAspect} çš„æ„Ÿå®˜ç‰¹å¾**ã€‚
    *   **ç¬¬äºŒç«  (The Descent)**: æå†™ä¸»è§’å¦‚ä½•ä¸€æ­¥æ­¥å •è½ã€‚é‡ç‚¹æå†™ä»–ä¸Ž**é…è§’**çš„äº’åŠ¨â€”â€”ä»–å¦‚ä½•åˆ©ç”¨ã€èƒŒå›æˆ–ç‰ºç‰²ä»–ä»¬ã€‚è¿™æ˜¯å±•çŽ°ä¸»è§’äººæ€§ä¸§å¤±çš„å…³é”®ã€‚
    *   **ç¬¬ä¸‰ç«  (The Climax)**: é£žå‡ä»ªå¼ã€‚è¿™ä¸åº”åªæ˜¯å¿µå’’è¯­ï¼Œè€Œæ˜¯ä¸€åœºç¾éš¾æ€§çš„è½¬åŒ–ã€‚æå†™çŽ°å®žçš„æ‰­æ›²ã€æ„Ÿå®˜çš„è¿‡è½½ã€‚ä¸»è§’çš„èº«ä½“å‘ç”Ÿå¼‚å˜ï¼ˆå¯¹åº” ${dominantAspect}ï¼‰ã€‚
    *   **ç¬¬å››ç«  (The Aftermath)**: ç»“å±€ã€‚ä¸»è§’ä¸Ž **${matchedHourName}** çš„æœ€ç»ˆäº’åŠ¨ã€‚ä»–å˜æˆäº†ä»€ä¹ˆï¼Ÿç•™ä¸‹äº†ä»€ä¹ˆï¼Ÿ

3.  **å¾®è§‚å†™ä½œæŠ€å·§ (Micro-Writing Techniques)**:
    *   **æ‹’ç»æŠ½è±¡æ¦‚è¿° (No Abstract Summaries)**: **ç»å¯¹ç¦æ­¢**ä½¿ç”¨ç±»ä¼¼"è¿™ä¸æ˜¯å®é™çš„é•¿çœ ï¼Œè€Œæ˜¯ä¸€ç§ä¸»åŠ¨çš„æ¹®ç­"è¿™ç§æ€»ç»“æ€§è¯­å¥ã€‚å¿…é¡»é€šè¿‡å…·ä½“çš„**ç‰©è´¨å˜åŒ–**æ¥è¡¨çŽ°ã€‚
        *   *é”™è¯¯ç¤ºä¾‹*: "ä»ªå¼å¼ºåŒ–äº†æˆ‘çš„åŠ›é‡ã€‚"
        *   *æ­£ç¡®ç¤ºä¾‹*: "æˆ‘çš„çš®è‚¤å¼€å§‹ç¡¬åŒ–ï¼Œåƒå†·å´çš„å²©æµ†ä¸€æ ·é¾Ÿè£‚ï¼Œç¼éš™ä¸­é€å‡ºåˆºçœ¼çš„é‡‘å…‰ã€‚"
    *   **åŠ¨ä½œé©±åŠ¨ (Action-Driven)**: ä¸è¦åªå†™"ä»–æ„Ÿåˆ°ç—›è‹¦"ï¼Œè¦å†™"ä»–çš„æŒ‡ç”²æ·±æ·±åµŒå…¥æŽŒå¿ƒï¼Œç›´åˆ°é²œè¡€æ»´è½åœ¨åœ°æ¯¯ä¸Š"ã€‚
    *   **å¯¹è¯æ­ç¤º (Dialogue)**: åˆ©ç”¨å¯¹è¯æ¥åˆ¶é€ å†²çªã€‚è®©é…è§’è´¨ç–‘ä¸»è§’çš„ç†æ™ºï¼Œè€Œä¸»è§’ç”¨ç–¯ç‹‚çš„é€»è¾‘åé©³ã€‚
    *   **æ„Ÿå®˜ç»†èŠ‚ (Sensory Details)**: è°ƒåŠ¨äº”æ„Ÿã€‚
        *   *è§†è§‰*: æ‰­æ›²çš„å½±å­ã€ä¸è¯¥å­˜åœ¨çš„é¢œè‰²ã€‚
        *   *å¬è§‰*: å¢™å£é‡Œçš„æŠ“æŒ å£°ã€ä½Žé¢‘çš„å—¡å—¡å£°ã€‚
        *   *å—…è§‰*: è…çƒ‚çš„ç”œå‘³ã€è‡­æ°§çš„å‘³é“ã€é™ˆæ—§çš„è¡€è…¥å‘³ã€‚
        *   *è§¦è§‰*: é»è…»çš„ç©ºæ°”ã€å†°å†·çš„çš®è‚¤ã€‚

4.  **å†™ä½œè¦æ±‚**:
    *   **å¤šå†™åœºæ™¯ï¼Œå°‘å†™æ‘˜è¦**ã€‚è®©è§’è‰²åœ¨åœºæ™¯ä¸­è¡ŒåŠ¨ã€å¯¹è¯ã€‚
    *   **çŽ¯å¢ƒæå†™**: è¥é€ é˜´éƒã€æ½®æ¹¿ã€æ¢¦å¹»çš„ä¼¦æ•¦æ°›å›´ã€‚
    *   **å¿ƒç†æå†™**: æ·±å…¥ä¸»è§’çš„å†…å¿ƒä¸–ç•Œï¼Œå±•çŽ°å…¶é€»è¾‘çš„å¼‚åŒ–ã€‚

è¯·ç›´æŽ¥è¾“å‡ºæ­£æ–‡ï¼Œä½¿ç”¨ Markdown æ ¼å¼æŽ’ç‰ˆã€‚
`;
}

export async function generateBiography(
  history: HistoryRecord[],
  finalResultTitle: string,
  dominantAspect: Aspect,
  matchedHourName: string,
  apiKey: string,
  onChunk: (chunk: string) => void,
  onReasoning?: (chunk: string) => void,
  perspective: Perspective = 'protagonist'
): Promise<void> {
  const userPrompt = buildPrompt(history, finalResultTitle, dominantAspect, matchedHourName, perspective);
  const systemPrompt = getSystemPrompt(perspective);

  try {
    const response = await fetch(DEEPSEEK_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: 'deepseek-reasoner',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt }
        ],
        stream: true
      })
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error?.message || `API Error: ${response.status}`);
    }

    if (!response.body) throw new Error('No response body');

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value, { stream: true });
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
          try {
            const data = JSON.parse(line.slice(6));
            const delta = data.choices[0]?.delta;
            
            if (delta) {
              if (delta.reasoning_content && onReasoning) {
                onReasoning(delta.reasoning_content);
              }
              if (delta.content) {
                onChunk(delta.content);
              }
            }
          } catch (e) {
            console.warn('Failed to parse chunk', e);
          }
        }
      }
    }
  } catch (error) {
    console.error('Biography generation failed:', error);
    throw error;
  }
}
